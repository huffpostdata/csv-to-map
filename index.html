<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>SVG map generator</title>
    <style>
      .input-block {
        display: inline-block;
        vertical-align: top;
      }

      textarea {
        width: 20rem;
        height: 30rem;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <button id="download-svg">Download as SVG</button>
    <button id="download-svg-compatible">Download as "compatible" SVG (no CSS)</button>
    <p>Paste CSV data here.</p>
    <p>Rules:</p>
    <ul>
      <li>The first column must be the county FIPS code.</li>
      <li>The second column must be a CSS class name, like <code>bucket0</code></li>
      <li>There must be <strong>no</strong> column headers.</li>
    </ul>
    <div class="input-block">
      <h2>CSV</h2>
      <textarea id="csv">32023,bucket0
04005,bucket1
06071,bucket2
56037,bucket3</textarea>
    </div>
    <div class="input-block">
      <h2>CSS</h2>
      <textarea id="css">
path {
  fill: #eee;
  stroke: white;
  stroke-width: 0.5;
}

path.states {
  fill: none;
  stroke: white;
  stroke-width: 1.5;
}

path.bucket0 {
  fill: #caa;
}

path.bucket1 {
  fill: #aca;
}

path.bucket2 {
  fill: #aac;
}

path.bucket3 {
  fill: #666;
}
      </textarea>
      <p>The only CSS rules that work with "compatible" are:</p>
      <ul>
        <li><a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/fill">fill</a></li>
        <li><a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/stroke">stroke</a></li>
        <li><a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/stroke-width">stroke-width</a></li>
      </ul>
    </div>
    <script src="//d3js.org/d3.v3.min.js"></script>
    <script src="//d3js.org/topojson.v1.min.js"></script>
    <script>
      var width = 960,
          height = 500;

      var path = d3.geo.path();

      var svg = d3.select('#map').append('svg')
        .attr('width', width)
        .attr('height', height);

      var defs = svg.append('defs');
      var style = defs.append('style');
      var g = svg.append('g').classed('counties', true);

      d3.json('us.json', function(error, topology) {
        if (error) throw error;

        g.selectAll('path')
          .data(topojson.feature(topology, topology.objects.counties).features)
          .enter().append('path')
          .attr('d', path);

        svg.append('path')
          .classed('states', true)
          .datum(topojson.mesh(topology, topology.objects.states, function(a, b) { return a !== b; }))
          .attr('d', path);

        function refresh() {
          var csv = document.querySelector('#csv').value;
          var rows = d3.csv.parseRows(csv);
          var fips_int_to_class = {};
          rows.forEach(function(row) {
            var fips_int = parseInt(row[0], 10);
            fips_int_to_class[fips_int] = row[1];
          });

          var css = document.querySelector('#css').value;
          style.text(css);

          g.selectAll('path')
            .attr('class', function(d) { return fips_int_to_class[d.id]; });
        }

        d3.select('#csv').on('change', refresh);
        refresh();
      });

      /*
       * Adobe Illustrator can't import an SVG that uses CSS. So we go through
       * and set the style to the computed style for all the attributes we can
       * think of.
       *
       * Luckily, we only care about fill, stroke and stroke-width, and all
       * those CSS rules have corresponding SVG attributes.
       */
      function svg_to_denormalized_xml(svg) {
        var div = document.createElement('div');
        document.body.appendChild(div);
        var svg2 = svg.cloneNode(true);
        div.appendChild(svg2);

        Array.prototype.forEach.call(svg2.querySelectorAll('path'), function(path) {
          var style = window.getComputedStyle(path);
          path.setAttribute('fill', style.fill);
          path.setAttribute('stroke', style.stroke);
          path.setAttribute('stroke-width', style.strokeWidth);
        });

        Array.prototype.forEach.call(svg2.querySelectorAll('style'), function(el) { el.remove(); });

        var svg = div.innerHTML
          .replace(/<svg/, '<svg version="1.1" xmlns="http://www.w3.org/2000/svg"');

        div.remove();
        return svg;
      }

      function send_string_to_browser(str) {
        var blob = new Blob([ str ]);
        var url = window.URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.setAttribute('download', 'map.svg');
        a.setAttribute('href', url);
        a.click();
      }

      function download_normal() {
        var s = document.querySelector('#map').innerHTML
          .replace(/<svg/, '<svg version="1.1" xmlns="http://www.w3.org/2000/svg"');
        send_string_to_browser(s);
      }

      function download_compatible() {
        var svg = document.querySelector('#map svg');
        var s = svg_to_denormalized_xml(svg);
        send_string_to_browser(s);
      }

      document.querySelector('#download-svg').addEventListener('click', download_normal);
      document.querySelector('#download-svg-compatible').addEventListener('click', download_compatible);
    </script>
  </body>
</html>
